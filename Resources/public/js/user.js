define(["require","exports","jquery","underscore","bootstrap","routing","ekyna-modal","ekyna-spinner","ekyna-dispatcher"],function(t,e,n,o,c,r,a,d,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.init=void 0;u.prototype.setAuthenticated=function(t,e){void 0===e&&(e=!1),this.authenticated!==t&&(this.authenticated=t,e||i.trigger("ekyna_user.authentication",{authenticated:this.authenticated}))},u.prototype.onXhrError=function(t,e){403===e.status&&(this.setAuthenticated(!1),this.openModal(r.generate("ekyna_user_security_login")))},u.prototype.onModalLinkClick=function(t){return t.preventDefault(),this.openModal(n(t.target).attr("href")),!1},u.prototype.openModal=function(t){var r=this,i=new a;return n(i).on("ekyna.modal.response",function(t){var e,n,o;"xml"==t.contentType?null!==(e=r.parseResponse(t.content))&&r.authenticated&&(t.preventDefault(),(n=i.getDialog()).getModalBody().html(e),o=[],n.getButtons().forEach(function(t){if("close"===t.id)return o.push(t),!1}),n.setButtons(o).enableButtons(!0)):"json"==t.contentType&&(t.preventDefault(),t.content.success&&(r.setAuthenticated(!0),t.modal.close()))}),i.load({url:t,method:"GET"}),i},u.prototype.parseResponse=function(t){var e,t=t.querySelector("user-widget");return t?(e=t.getAttribute("redirect"))?(window.location.href=e,null):(this.setAuthenticated(1===parseInt(t.getAttribute("status"))),t.textContent):null};var s=u;function u(){this.modalLinkClickHandler=o.bind(this.onModalLinkClick,this),this.xhrErrorHandler=o.bind(this.onXhrError,this),n(document).on("click","[data-user-modal]",this.modalLinkClickHandler),n(document).on("ajaxError",this.xhrErrorHandler)}e.init=function(){return new s}});