define(["require","exports","jquery","underscore","bootstrap","ekyna-modal","ekyna-ui","ekyna-dispatcher"],function(a,b,c,d,e,f,g,h){"use strict";var i=function(){function a(){}return a}(),j=function(){function a(){this.enabled=!1}return a.prototype.initialize=function(a){if(this.config=d.defaults(a||{},{widgetSelector:"#user-widget",toggleSelector:"> a",contentSelector:"> div"}),this.$widget=c(this.config.widgetSelector),1!=this.$widget.length)throw"Widget not found ! ("+this.config.widgetSelector+")";if(this.$content=this.$widget.find(this.config.contentSelector),1!=this.$content.length)throw"Widget content not found ! ("+this.config.contentSelector+")";if(this.$toggle=this.$widget.find(this.config.toggleSelector),1!=this.$toggle.length)throw"Widget toggle button not found ! ("+this.config.toggleSelector+")";return this.contentShowHandler=d.bind(this.onContentShow,this),this.modalLinkClickHandler=d.bind(this.onModalLinkClick,this),this},a.prototype.enable=function(){if(!this.enabled)return this.enabled=!0,this.$widget.on("show.bs.dropdown",this.contentShowHandler),c(document).on("click","[data-user-modal]",this.modalLinkClickHandler),this},a.prototype.disable=function(){if(this.enabled)return this.enabled=!1,this.$widget.off("show.bs.dropdown",this.contentShowHandler),c(document).off("click","[data-user-modal]",this.modalLinkClickHandler),this},a.prototype.onContentShow=function(){this.$content.is(":empty")&&this.loadContent()},a.prototype.onModalLinkClick=function(a){var b=this;a.preventDefault();var d=new f;return c(d).on("ekyna.modal.response",function(a){"xml"==a.contentType?b.parseResponse(a.content)&&a.preventDefault():"json"==a.contentType&&(a.preventDefault(),a.content.success&&(b.loadContent(),d.close()))}),d.load({url:c(a.target).attr("href"),method:"GET"}),!1},a.prototype.loadContent=function(){var a=this;this.$content.loadingSpinner("on"),this.contentXHR&&this.contentXHR.abort(),this.contentXHR=c.ajax({url:this.$widget.data("url"),dataType:"xml",cache:!1}),this.contentXHR.done(function(b){return a.parseResponse(b)}),this.contentXHR.fail(function(){console.log("Failed to load account widget content.")})},a.prototype.parseResponse=function(a){var b=a.querySelector("user-widget");if(b){this.$content.loadingSpinner("off").html(b.textContent);var c=new i;return c.authenticated=1==parseInt(b.getAttribute("status")),h.trigger("ekyna_user.user_status",c),!0}return!1},a}();return new j});